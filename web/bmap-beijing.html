<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        body, html{width: 100%;height: 100%;overflow: hidden;margin:0;font-family:"微软雅黑";}
        .allmap{
            width: 600px;height: 500px;
        }
        .BMap_cpyCtrl {
            display: none;
        }
        .anchorBL {
            display: none;
        }
    </style>
    <script src="resources/jquery-2.2.3.min.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=3.0&ak=wkMfrL0doQeSxjBTRT16vssL"></script>
    <script src="resources/bmap/heatmap.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/AreaRestriction/1.2/src/AreaRestriction_min.js"></script>
    <script type="text/javascript" src="resources/request/ajaxrequestasync.js"></script>
    <script type="text/javascript" src="resources/request/ajaxrequestsync.js"></script>
    <title>添加行政区划</title>
</head>
<body>
<div id="allmap" class="allmap"></div>
</body>
</html>
<script type="text/javascript">
    var params
    function rquestParams(method,api,data){
        var jsonDataList={
            httpMethod:method,
            url:api,
            data:data?JSON.stringify(data):''
        };
        return jsonDataList;
    }
    var jsonDataList = rquestParams("POST","http://10.32.0.169:8120/hub/map/getBMapByAreaCode.html",{"areaCode":"360000","mapType":"1"});
    ajaxrequestasync(jsonDataList,function(code,msg,json){
        if(code=='200'){
            var body =json.body;
            console.info(body.areaCfg);

        }
    });

    // 百度地图API功能
    var map = new BMap.Map("allmap");
    var cfgs = {
        //地图显示级别
        zoom:18,
        jdWd:true,
        //地图中心
        point:{
            lng:116.403765,
            lat:39.914850,
            cityName:'北京市'
        },
        //115.858261,28.697059
//        point:{
//            lng:115.858261,
//            lat:39.914850,
//            cityName:'江西省'
//        },

        //地图上文字显示样式
        lableStyle:{
            color : "green",
            fontFamily:"微软雅黑",
            border:'none',
            backgroundColor:'transparent'
        },
        //地图显示样式
        styleJson:[{
            "featureType": "poi",
            "elementType": "all",
            "stylers": {
                "color": "red",
                "visibility": "off"
            }
        }, {
            "featureType": "road",
            "elementType": "all",
            "stylers": {
                "color": "#ffffff",
                "visibility": "off"
            }
        },{
            "featureType": "background",
            "elementType": "all",
            "stylers": {
                "color": "#ffffff"
            }
        },{
            "featureType": "administrative",
            "elementType": "all",
            "stylers": {
                "color": "#ffffff",
                "visibility": "off"
            }
        }],
        //当前地图的下级行政区
        areaCfg:[{
            name:"顺义区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"昌平区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'yellow'
            }
        },{
            name:"西城区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'yellow'
            }
        },{
            name:"朝阳区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'yellow'
            }
        },{
            name:"东城区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"丰台区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"石景山区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"海淀区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"门头沟区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"房山区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"通州区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"大兴区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"怀柔区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"平谷区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"密云区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }
        },{
            name:"延庆区",
            style:{
                strokeWeight:2,
                strokeColor:'#00FF00',
                fillOpacity:1,
                fillColor:'#eeeeee'
            }

        }],
        //南昌市、九江市、上饶市、抚州市、宜春市、吉安市、赣州市、景德镇市、萍乡市、新余市、鹰潭市
//        areaCfg:[{
//            name:"南昌市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'yellow'}
//        },{
//            name:"九江市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        },{
//            name:"上饶市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        },{
//            name:"抚州市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        },{
//            name:"宜春市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        },{
//            name:"吉安市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        },{
//            name:"赣州市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        },{
//            name:"景德镇市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        },{
//            name:"萍乡市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        },{
//            name:"新余市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        },{
//            name:"鹰潭市",
//            style:{strokeWeight:2,strokeColor:'#00FF00', fillOpacity:1,fillColor:'#beffa5'}
//        }],
        //遮罩层
        polygon:{
            strokeOpacity: 0.0000001,
            strokeColor: "#000000",
            strokeWeight: 0.00001,
            fillColor: "#5CFF1C",
            fillOpacity: 0.4
        }
    };
    console.info(JSON.stringify(cfgs));
    map.setMapStyle({
        styleJson:cfgs.styleJson
    });
    if(cfgs.jdWd){
        map.centerAndZoom(new BMap.Point(cfgs.point.lng, cfgs.point.lat), cfgs.zoom);
    }else{
        map.centerAndZoom(cfgs.point.cityName||'北京市', cfgs.zoom);
    }
    map.enableScrollWheelZoom();

    var blist = [];
    var districtLoading = 0;

    function getBoundary() {
        debugger;
        for(var i=0;i<cfgs.areaCfg.length;i++){
            addDistrict(cfgs.areaCfg[i]);
        }
    }

//    setTimeout(function(){
//        getBoundary();
//    }, 0);
    /**
     * 添加行政区划
     * @param {} districtName 行政区划名
     * @returns  无返回值
     */
    function addDistrict(districtNameCfg) {
        //使用计数器来控制加载过程
        districtLoading++;
        var bdary = new BMap.Boundary();
        bdary.get(districtNameCfg.name, function (rs) {       //获取行政区域
            var count = rs.boundaries.length; //行政区域的点有多少个
            if (count === 0) {
                alert('未能获取当前输入行政区域');
                return;
            }
            for (var i = 0; i < count; i++) {
                blist.push({ points: rs.boundaries[i], name: districtNameCfg.name ,style:districtNameCfg.style});
            };
            //加载完成区域点后计数器-1
            districtLoading--;
            if (districtLoading == 0) {
                //全加载完成后画端点
                drawBoundary();
            }
        });
    }


    /**
     * 各种鼠标事件绑定
     */
    function clickTest(evt) {
        debugger;
        console.info(evt.target.name);
    }

    function mouseover(evt) {
        evt.target.label.setZIndex(99);
        evt.target.label.setPosition(evt.point);
        evt.target.label.show();
    }

    function mousemove(evt) {
        evt.target.label.setPosition(evt.point);
    }

    function mouseout(evt) {
        evt.target.label.hide();
    }


    function drawBoundary() {
        //包含所有区域的点数组
        var pointArray = [];

        /*画遮蔽层的相关方法
         *思路: 首先在中国地图最外画一圈，圈住理论上所有的中国领土，然后再将每个闭合区域合并进来，并全部连到西北角。
         *      这样就做出了一个经过多次西北角的闭合多边形*/
        //定义中国东南西北端点，作为第一层
        var pNW = { lat: 59.0, lng: 73.0 }
        var pNE = { lat: 59.0, lng: 136.0 }
        var pSE = { lat: 3.0, lng: 136.0 }
        var pSW = { lat: 3.0, lng: 73.0 }
        //向数组中添加一次闭合多边形，并将西北角再加一次作为之后画闭合区域的起点
        var pArray = [];
        pArray.push(pNW);
        pArray.push(pSW);
        pArray.push(pSE);
        pArray.push(pNE);
        pArray.push(pNW);
        //循环添加各闭合区域
        for (var i = 0; i < blist.length; i++) {
            //添加显示用标签层
            var label = new BMap.Label(blist[i].name, { offset: new BMap.Size(20, -10) });
            label.hide();
            map.addOverlay(label);

            //添加多边形层并显示
            var ply = new BMap.Polygon(blist[i].points, blist[i].style);

            ply.name = blist[i].name;
            ply.label = label;
            ply.addEventListener("click", clickTest);
            ply.addEventListener("mouseover", mouseover);
            ply.addEventListener("mouseout", mouseout);
            ply.addEventListener("mousemove", mousemove);
            map.addOverlay(ply);

            //添加名称标签层
            var centerlabel = new BMap.Label(ply.name, { offset: new BMap.Size(0, 0) });
            centerlabel.setPosition(ply.getBounds().getCenter());
            centerlabel.setStyle(cfgs.lableStyle);
            map.addOverlay(centerlabel);

            //将点增加到视野范围内
            var path = ply.getPath();
            pointArray = pointArray.concat(path);
            //将闭合区域加到遮蔽层上，每次添加完后要再加一次西北角作为下次添加的起点和最后一次的终点
            pArray = pArray.concat(path);
            pArray.push(pArray[0]);
        }

        //限定显示区域，需要引用api库
        var boundply = new BMap.Polygon(pointArray);
        BMapLib.AreaRestriction.setBounds(map, boundply.getBounds());
        map.setViewport(pointArray);    //调整视野

        //添加遮蔽层
        var plyall = new BMap.Polygon(pArray, cfgs.polygon); //建立多边形覆盖物
        map.addOverlay(plyall);
    }

    setTimeout(function () {
        getBoundary();
    }, 100);
</script>